"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[336],{5336:function(e,t,l){l.r(t),l.d(t,{default:function(){return z}});var i=l(2676),n=l(5271),s=l(6058),a=l(4060),r=e=>{let{data:t,plainData:l,selectedNodeId:n,handleNodeSelection:s}=e;return(0,i.jsxs)("div",{className:"mt-5 bg-white shadow-md w-77 box-border rounded-lg p-6 border border-gray-200",children:[(0,i.jsx)("div",{className:"mb-2",children:(0,i.jsxs)("h2",{children:["Most Expensive Nodes ",(0,i.jsxs)("span",{children:["(",null==t?void 0:t.length," of ",null==l?void 0:l.length,")"]})]})}),null==t?void 0:t.map(e=>(0,i.jsxs)("div",{className:"expensive-nodes-node ".concat(n===e.id?"selected":""),onClick:()=>s(null==e?void 0:e.id),children:[(0,i.jsxs)("div",{className:"expensive-nodes-node-name",children:[null==e?void 0:e.name," [",null==e?void 0:e.id,"]"]}),(0,i.jsx)("div",{className:"expensive-nodes-node-percentage",children:null==e?void 0:e.totalTimePercent})]},e.id))]})},d=l(888),o=e=>{let{overviewInfo:t,queryDuration:l=0}=e;return(0,i.jsxs)("div",{className:"expensive-nodes-card",children:[(0,i.jsx)("div",{className:"expensive-nodes-card-header",children:(0,i.jsxs)("h2",{children:["Profile Overview ",(0,i.jsx)("span",{children:"(Finished)"})]})}),(0,i.jsxs)("div",{className:"expensive-nodes-node",children:[(0,i.jsx)("div",{className:"expensive-nodes-node-name",children:"Total Execution Time"}),(0,i.jsxs)("div",{className:"expensive-nodes-node-percentage",children:["(",(0,d.Z)(Math.floor(l/1e3/1e3)),")",null==t?void 0:t.totalTimePercent]})]}),(0,i.jsxs)("div",{className:"expensive-nodes-node",children:[(0,i.jsxs)("div",{className:"expensive-nodes-node-name",children:[(0,i.jsx)("span",{className:"custom-dot",style:{backgroundColor:"rgb(28, 130, 242)"}}),"CPU Time"]}),(0,i.jsx)("div",{className:"expensive-nodes-node-percentage",children:null==t?void 0:t.cpuTimePercent})]}),(0,i.jsxs)("div",{className:"expensive-nodes-node",children:[(0,i.jsxs)("div",{className:"expensive-nodes-node-name",children:[(0,i.jsx)("span",{className:"custom-dot",style:{backgroundColor:"rgb(255, 152, 0)"}}),"I/O Time"]}),(0,i.jsx)("div",{className:"expensive-nodes-node-percentage",children:null==t?void 0:t.waitTimePercent})]})]})},c=l(1471),u=e=>{let{overviewInfo:t}=e,l=parseFloat((null==t?void 0:t.cpuTimePercent)||"0");return(0,i.jsxs)("div",{className:"expensive-nodes-card",children:[(0,i.jsx)("div",{className:"expensive-nodes-card-header",children:(0,i.jsx)("h2",{children:"Profile Overview"})}),(0,i.jsxs)("div",{className:"expensive-nodes-progress",children:[(0,i.jsx)(c.Z,{percent:l,trailColor:"rgba(255, 152, 0)",strokeColor:"rgb(28, 130, 242)",status:"active",showInfo:!1}),(0,i.jsx)("div",{className:"expensive-nodes-percentage",children:null==t?void 0:t.totalTimePercent})]}),(0,i.jsxs)("div",{className:"expensive-nodes-node",children:[(0,i.jsxs)("div",{className:"expensive-nodes-node-name",children:[(0,i.jsx)("span",{className:"custom-dot",style:{backgroundColor:"rgb(28, 130, 242)"}}),"CPU Time"]}),(0,i.jsx)("div",{className:"expensive-nodes-node-percentage",children:null==t?void 0:t.cpuTimePercent})]}),(0,i.jsxs)("div",{className:"expensive-nodes-node",children:[(0,i.jsxs)("div",{className:"expensive-nodes-node-name",children:[(0,i.jsx)("span",{className:"custom-dot",style:{backgroundColor:"rgb(255, 152, 0)"}}),"I/O Time"]}),(0,i.jsx)("div",{className:"expensive-nodes-node-percentage",children:null==t?void 0:t.waitTimePercent})]})]})},v=e=>{let{statisticsData:t}=e,l=(0,n.useMemo)(()=>{var e;return null==t?void 0:null===(e=t.statistics)||void 0===e?void 0:e.slice(2)},[t]),s=(0,n.useMemo)(()=>(null==l?void 0:l.filter(e=>!!e.value).length)>0,[l]);return(0,i.jsx)(i.Fragment,{children:s&&(0,i.jsxs)("div",{className:"expensive-nodes-card",children:[(0,i.jsx)("div",{className:"expensive-nodes-card-header",children:(0,i.jsx)("h2",{children:"Statistics"})}),null==l?void 0:l.map((e,t)=>!!e.value&&(0,i.jsxs)("div",{className:"expensive-nodes-node",children:[(0,i.jsx)("div",{className:"expensive-nodes-node-name",children:e.name}),(0,i.jsxs)("div",{className:"expensive-nodes-node-percentage",children:[e.value," ",e.unit]})]},t))]})})},m=e=>{let{attributesData:t}=e;return(0,i.jsx)(i.Fragment,{children:(null==t?void 0:t.length)>0&&(0,i.jsxs)("div",{className:"expensive-nodes-card",children:[(0,i.jsx)("div",{className:"expensive-nodes-card-header",children:(0,i.jsx)("h2",{children:"Attributes"})}),null==t?void 0:t.map((e,t)=>{var l;return(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"expensive-nodes-node-title",children:e.name}),(0,i.jsx)("div",{className:"expensive-nodes-node block",children:null==e?void 0:null===(l=e.value)||void 0===l?void 0:l.map((e,t)=>(0,i.jsx)("div",{className:"expensive-nodes-node-name",children:e},t))})]},t)})]})})},h=l(4807),x=l(1587);let p="OutputRows",f=[["M",21.0374,60],["H",15],["C",12.7909,60,11,61.79086,11,64],["C",11,66.2091,12.7909,68,15,68],["H",21.1059],["C",19.8458,69.9437,15.7082+2,71.2309,15.2964,71.0062],["C",4.5,70,1,69.5,4,63.5],["C",-.5,57.00616,11.5,56.5,15.2964,57.00616],["C",17.6724,57.00616,19.772,58.18999,21.0374,60],["Z"]],g=[["M",125.5,-18],["L",131.9952,-6.75],["L",119.00481,-6.75],["L",125.5,-18],["Z"],["M",125.5,-1],["L",125.5,-7]];function j(e){return e<1e3?e.toString():e>=1e3&&e<1e6?(e/1e3).toFixed(1)+"K":e>=1e6&&e<1e9?(e/1e6).toFixed(1)+"M":(e/1e9).toFixed(1)+"B"}let b=(e,t,l,i,n)=>[["M",e+n,t],["l",l-2*n,0],["a",n,n,0,0,1,n,n],["l",0,i-2*n],["a",n,n,0,0,1,-n,n],["l",-l+2*n,0],["a",n,n,0,0,1,-n,-n],["l",0,-i+2*n],["a",n,n,0,0,1,n,-n],["Z"]],N=e=>{if(!e||0===e.length)return[];let t=-1;for(let l of e){let{statisticsDescArray:e}=l;if(e&&-1===t&&-1!==(t=e.findIndex(e=>e._type===p)))break}return -1===t&&(t=0),e.map(e=>{var l;let{title:i,name:n,id:s,statisticsDescArray:a}=e,r=(null==a?void 0:null===(l=a[t])||void 0===l?void 0:l._value)||0;return{totalTime:e.totalTime,id:s,outputRows:r,value:{title:((null==n?void 0:n.length)>=26?n.slice(0,26)+"...":n||"  ")+" [".concat(s,"]"),items:[{text:i||"  "}]}}})},T=e=>{if(!e||0===e.length)return[];let t=-1;for(let l of e){let{statisticsDescArray:e}=l;if(e&&-1===t&&-1!==(t=e.findIndex(e=>e._type===p)))break}return -1===t&&(t=0),e.map(e=>{var l;let{statisticsDescArray:i,parent_id:n,id:s}=e,a=(null==i?void 0:null===(l=i[t])||void 0===l?void 0:l._value)||0,r={source:n,target:s};return a<=0?r:{...r,value:j(a),_value:a}})},w=e=>"string"==typeof e?e:e.src,y=w({src:"/_next/static/media/full-screen.7d6ebd20.svg",height:16,width:16,blurWidth:0,blurHeight:0}),C=w({src:"/_next/static/media/zoom-in.a278e09b.svg",height:16,width:16,blurWidth:0,blurHeight:0}),S=w({src:"/_next/static/media/zoom-out.37a3b592.svg",height:16,width:16,blurWidth:0,blurHeight:0}),_=w({src:"/_next/static/media/download.9b92a3cc.svg",height:16,width:16,blurWidth:0,blurHeight:0}),k=e=>{let{graphSize:t,onReady:l,data:s,graphRef:a,overviewInfoCurrent:r,handleResetView:d}=e,o=(0,n.useCallback)(e=>{let{zoomIn:t,zoomOut:l}=e;return(0,i.jsxs)("div",{className:"flex justify-around items-center",children:[(0,i.jsx)("span",{className:"cursor-pointer flex justify-center items-center",onClick:()=>d(),children:(0,i.jsx)("img",{src:y,alt:"full screen"})}),(0,i.jsx)("span",{className:"cursor-pointer flex justify-center items-center",onClick:l,children:(0,i.jsx)("img",{src:S,alt:"zoom out"})}),(0,i.jsx)("span",{className:"cursor-pointer flex justify-center items-center",onClick:t,children:(0,i.jsx)("img",{src:C,alt:"zoom in"})}),(0,i.jsx)("span",{className:"g-cursor g-box-c",onClick:()=>{var e;return null==a?void 0:null===(e=a.current)||void 0===e?void 0:e.downloadFullImage("databend-profile","image/png")},children:(0,i.jsx)("img",{src:_,alt:"download"})})]})},[d,a]),c=e=>({radius:5,fill:"#fff",stroke:"#ccc",filter:"drop-shadow(2px 3px 2px rgba(255, 255, 255, .2))"}),u=e=>{var t;return{fontWeight:600,fill:(null==e?void 0:null===(t=e.errors)||void 0===t?void 0:t.length)?"#fff":"#000"}},v=e=>({lineWidth:(null==e?void 0:e.lineWidth)||1}),m=(0,n.useCallback)((e,t,l)=>{var i,n,a,d,o,c,u;let{startX:v,startY:m,width:h}=l,{text:x}=e,p=null==x?void 0:x.length,N=null==t?void 0:null===(a=t.cfg)||void 0===a?void 0:null===(n=a.item)||void 0===n?void 0:null===(i=n._cfg)||void 0===i?void 0:i.model,T=(null==N?void 0:N.totalTime)/((null===(d=r.current)||void 0===d?void 0:d.totalTime)||1),w=null==N?void 0:null===(o=N.errors)||void 0===o?void 0:o.length,y=null==N?void 0:N.parent_id,C=t.addShape("text",{attrs:{textBaseline:"top",x:v,y:m,text:x,fill:w?"rgba(255,255,255,0.8)":"#75767a",textAlign:"left"},name:"text-".concat(Math.random())}),S=C.getBBox().width;if(p>26&&S>h){let e=x.slice(0,Math.floor(h/S*p-3))+"...";C.attr("text",e)}let _=null!==(c=null==C?void 0:C.getBBox().height)&&void 0!==c?c:0,k=230*T,P=b(v,m+_+10,230,8,4);t.addShape("path",{attrs:{path:P,fill:"#f2f2f2"},name:"progress-bg-".concat(Math.random())});let M=b(v,m+_+10,k,8,4);if(t.addShape("path",{attrs:{path:M,fill:k<=0?"rgba(0,0,0,0)":"rgb(1, 117, 246)"},name:"progress-fg-".concat(Math.random())}),k>0&&k<9&&t.addShape("path",{attrs:{path:f,fill:w?"#f73920":"#fff"},name:"circle-path-bg-".concat(Math.random())}),"null"===y){let e=null===(u=s.edges)||void 0===u?void 0:u.find(e=>(null==e?void 0:e.source)==="null");t.addShape("path",{attrs:{path:g,fill:"#ccc",stroke:"#ccc",lineWidth:(null==e?void 0:e.lineWidth)||1},name:"percentage-output-text-".concat(Math.random())});let l=j(null==N?void 0:N.outputRows);t.addShape("text",{attrs:{textBaseline:"top",x:125+function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"12px Arial",l=document.createElement("canvas").getContext("2d");return l?(l.font=t,l.measureText(e).width):0}(l)/2,y:-30,text:l,fill:"rgba(12, 22, 43, 0.6)",fontWeight:"bold",fontSize:12,textAlign:"right"},name:"percentage-output-text"})}let E=T>0?"".concat((100*T).toFixed(1),"%"):"0%";return t.addShape("text",{attrs:{textBaseline:"top",x:v+h,y:m-27,text:E,fill:w?"#fff":"#000",fontSize:11,textAlign:"right"},name:"percentage-text-".concat(Math.random())}),Math.max(_,8)},[r,s]);return(0,n.useMemo)(()=>({...t,onReady:l,data:s,layout:{rankdir:"TB",ranksepFunc:()=>20},toolbarCfg:{className:"absolute top-0 left-0 w-[100px]",show:!0,customContent:o},nodeCfg:{padding:10,size:[250,40],title:{autoEllipsis:!0,containerStyle:{fill:"transparent"},style:u},anchorPoints:[[.5,0],[.5,1]],style:c,nodeStateStyles:{highlight:{stroke:"#2c91ff",lineWidth:2},hover:{stroke:"#2c91ff",lineWidth:2}},customContent:m},edgeCfg:{type:"cubic-vertical",endArrow:!1,style:v,label:{style:{fontWeight:600,fill:"rgba(12, 22, 43, 0.6)"}},startArrow:{type:"triangle"}},markerCfg:e=>{var t;return{animate:!0,position:"bottom",show:null===(t=s.edges.filter(t=>t.source===e.id))||void 0===t?void 0:t.length}},behaviors:["drag-canvas","zoom-canvas"]}),[t,l,s,m,o])};var P=(0,n.memo)(e=>{let{plainData:t,graphSize:l,graphRef:s,overviewInfoCurrent:a,onReady:r}=e,[d,o]=(0,n.useState)(0),c=k({graphSize:l,onReady:r,data:(0,n.useMemo)(()=>{let e=function(e){if(!e||e.length<=2)return e;let t=1/0,l=-1/0,i=[];if(e.forEach(e=>{(null==e?void 0:e._value)!==void 0&&(i.push(null==e?void 0:e._value),(null==e?void 0:e._value)<t&&(t=null==e?void 0:e._value),(null==e?void 0:e._value)>l&&(l=null==e?void 0:e._value))}),0===i.length)return e;let n=l-t,s=0===n?0:3.5/n;return e.forEach(e=>{void 0!==e._value?e.lineWidth=1+(e._value-t)*s:e.lineWidth=1}),e}(T(t));return{nodes:N(t),edges:e}},[t]),graphRef:s,overviewInfoCurrent:a,handleResetView:()=>{let e=null==s?void 0:s.current;e&&(e.fitView(),e.refresh())}});return(0,n.useEffect)(()=>{o(e=>e+1)},[t,l]),(0,i.jsx)(h.Z,{...c},d)},(e,t)=>{let l=(0,x.Z)(e.plainData,t.plainData),i=(0,x.Z)(e.graphSize,t.graphSize);return l&&i});function M(e,t){return 0===t?"0%":"".concat((e/t*100).toFixed(1),"%")}let{Content:E,Sider:W}=a.default;var z=e=>{var t;let{perfData:l}=e;(0,s.useRouter)();let[d,c]=(0,n.useState)("all"),[h,x]=(0,n.useState)([]),[p,f]=(0,n.useState)([]),[g,j]=(0,n.useState)([]),[b,N]=(0,n.useState)([]),[T,w]=(0,n.useState)(void 0),[y,C]=(0,n.useState)(!0),[S,_]=(0,n.useState)({width:800,height:600}),k=(0,n.useRef)(null),z=(0,n.useRef)(null),F=(0,n.useRef)(null),I=(0,n.useRef)(null),R=(0,n.useRef)(void 0),A=(0,n.useCallback)((e,t)=>{var l,i;let n=null===(l=t.CpuTime)||void 0===l?void 0:l.index,s=null===(i=t.WaitTime)||void 0===i?void 0:i.index,a=0,r=0;e.forEach(e=>{var l;e.id=String(e.id),e.parent_id=String(e.parent_id);let i=(null==e?void 0:e.statistics[n])||0,d=(null==e?void 0:e.statistics[s])||0;e.totalTime=i+d,e.cpuTime=i,e.waitTime=d,a+=i,r+=d,e.errors=(null==e?void 0:null===(l=e.errors)||void 0===l?void 0:l.length)>0?(null==e?void 0:e.errors).map(e=>{let t=Object.keys(e)[0];return{_errorType:t,...e[t]}}):[],e.statisticsDescArray=Object.entries(t).map(t=>{let[l,i]=t;return{_type:l,desc:null==i?void 0:i.desc,display_name:(null==i?void 0:i.display_name)||(null==i?void 0:i.displayName),index:null==i?void 0:i.index,unit:i.unit,plain_statistics:null==i?void 0:i.plain_statistics,_value:e.statistics[null==i?void 0:i.index]}})});let d=a+r;return e.forEach(e=>{e.totalTimePercent=M(null==e?void 0:e.totalTime,d),e.cpuTimePercent=M(null==e?void 0:e.cpuTime,e.totalTime),e.waitTimePercent=M(null==e?void 0:e.waitTime,e.totalTime)}),e},[]),B=(0,n.useCallback)(e=>{let t=e.reduce((e,t)=>e+t.cpuTime,0),l=e.reduce((e,t)=>e+t.waitTime,0),i=t+l,n=M(t,i),s=M(l,i);return{cpuTime:t,waitTime:l,totalTime:i,totalTimePercent:"100%",cpuTimePercent:n,waitTimePercent:s,statisticsDescArray:[],errors:[]}},[]);(0,n.useEffect)(()=>{let e=()=>{if(k.current){let e=k.current.getBoundingClientRect();_({width:e.width,height:e.height})}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,n.useEffect)(()=>{if(l)try{C(!0);let e=A(l.profiles,l.statistics_desc),t=B(e);x(e),f(e.filter(e=>parseFloat(e.totalTimePercent)>0).sort((e,t)=>t.totalTime-e.totalTime)),w(t),R.current=t,j(e.map(e=>{var t;return{statistics:Object.entries(l.statistics_desc).map(t=>{let[l,i]=t;return{name:i.display_name||l,desc:i.desc,value:e.statistics[i.index],unit:i.unit}}),id:(null==e?void 0:null===(t=e.id)||void 0===t?void 0:t.toString())||""}})),N(e.map(e=>{var t;return{labels:e.labels,id:(null==e?void 0:null===(t=e.id)||void 0===t?void 0:t.toString())||""}}))}catch(e){console.error("Error processing perf data:",e)}finally{C(!1)}else C(!1)},[l,A,B]);let D=(0,n.useCallback)(e=>{if(c(e),!I.current)return;let t=I.current,l=t.getNodes();null==l||l.forEach(e=>{t.clearItemStates(e)});let i=null==l?void 0:l.find(t=>{var l;return(null==t?void 0:null===(l=t._cfg)||void 0===l?void 0:l.id)===e});i&&t.setItemState(i,"highlight",!0)},[]),Z=(0,n.useCallback)(e=>{e.on("node:click",e=>{var t,l;let i=null===(l=e.item)||void 0===l?void 0:null===(t=l._cfg)||void 0===t?void 0:t.model,n=(null==i?void 0:i.id)!=null?String(i.id):void 0;n&&D(n)}),e.on("node:mouseleave",()=>{if(!F.current){var e;F.current=null!==(e=document.getElementsByTagName("canvas")[0])&&void 0!==e?e:null}F.current&&(F.current.style.cursor="move")}),e.on("canvas:click",()=>{c("all");let t=e.getNodes();null==t||t.forEach(t=>{e.clearItemStates(t)})}),e.on("canvas:dragstart",()=>{(null==z?void 0:z.current)&&(z.current.style.userSelect="none")}),e.on("canvas:dragend",()=>{(null==z?void 0:z.current)&&(z.current.style.userSelect="unset")})},[D]),O=(0,n.useMemo)(()=>{if("all"===d)return T;let e=h.find(e=>e.id===d);if(e)return{cpuTime:e.cpuTime,waitTime:e.waitTime,totalTime:e.totalTime,totalTimePercent:e.totalTimePercent,cpuTimePercent:e.cpuTimePercent,waitTimePercent:e.waitTimePercent,labels:e.labels,statisticsDescArray:e.statisticsDescArray,errors:e.errors,name:e.name}},[d,T,h]);return y?(0,i.jsx)("div",{className:"h-screen flex items-center justify-center",children:(0,i.jsx)("div",{className:"text-lg",children:"Loading performance data..."})}):l&&0!==h.length?(0,i.jsx)(a.default,{children:(0,i.jsx)("div",{ref:k,className:"bg-white w-full rounded-lg",children:(0,i.jsx)(a.default,{children:(0,i.jsxs)(E,{className:"p-6 w-full flex",children:[(0,i.jsx)("div",{ref:z,className:"flex-1 flex justify-center items-center h-screen",children:(0,i.jsx)(P,{plainData:h,graphSize:S,graphRef:I,overviewInfoCurrent:R,onReady:e=>{y?(e.fitView(),e.refresh(),C(!1)):(I.current=e,e.setMaxZoom(2),e.setMinZoom(.5),Z(e))}})}),(0,i.jsx)(W,{width:308,style:{background:"#fff"},children:(0,i.jsxs)("div",{className:"overflow-y-auto",style:{height:S.height},children:[(0,i.jsx)(r,{data:p,plainData:h,selectedNodeId:d,handleNodeSelection:D}),"all"!==d?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(u,{overviewInfo:O}),(0,i.jsx)(v,{statisticsData:g.find(e=>e.id===d)}),(0,i.jsx)(m,{attributesData:null===(t=b.find(e=>e.id===d))||void 0===t?void 0:t.labels})]}):(0,i.jsx)(o,{queryDuration:(null==T?void 0:T.totalTime)||0,overviewInfo:T})]})})]})})})}):(0,i.jsx)("div",{className:"h-screen flex items-center justify-center",children:(0,i.jsx)("div",{className:"text-lg text-gray-500",children:"No performance data available"})})}}}]);