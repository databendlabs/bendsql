"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[870],{4870:function(e,t,r){r.r(t),r.d(t,{default:function(){return M}});var l=r(2676),n=r(5271),o=r(9822),s=r(9675),a=r(4887),i=r(987),d=r(9619),c=r(5122);function u(e){if(!e)return"";let t=e instanceof Date?e:new Date(e);if(isNaN(t.getTime()))return"";let r=Date.now()-t.getTime();return r<6e4?"just now":r<36e5?"".concat(Math.floor(r/6e4),"m ago"):r<864e5?"".concat(Math.floor(r/36e5),"h ago"):r<6048e5?"".concat(Math.floor(r/864e5),"d ago"):t.toLocaleDateString()}let x=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),g=e=>{let t=x(e);return(t=(t=(t=(t=(t=t.replace(/`([^`]+)`/g,"<code>$1</code>")).replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/__([^_]+)__/g,"<strong>$1</strong>")).replace(RegExp("(?<!\\*)\\*([^*]+)\\*","g"),"<em>$1</em>")).replace(RegExp("(?<!_)_([^_]+)_","g"),"<em>$1</em>")).replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noreferrer noopener">$1</a>')},p=e=>{let t=e.replace(/\r\n?/g,"\n").split("\n"),r=[],l=[],n=[],o=!1,s=()=>{if(0===l.length)return;let e=l.map(e=>{let t=e.replace(/^\s*[-*+]\s+/,"");return"<li>".concat(g(t),"</li>")}).join("");r.push("<ul>".concat(e,"</ul>")),l=[]},a=()=>{0!==n.length&&(r.push("<pre><code>".concat(x(n.join("\n")),"</code></pre>")),n=[])};for(let e of t){let t=e.trimEnd();if(/^```/.test(t)){o?(a(),o=!1):(s(),o=!0);continue}if(o){n.push(e);continue}if(/^\s*[-*+]\s+/.test(e)){l.push(e);continue}if(s(),!t.trim()){r.push("");continue}if(/^>/.test(t)){let e=t.replace(/^>\s?/,"");r.push("<blockquote>".concat(g(e),"</blockquote>"));continue}let i=t.match(/^(#{1,6})\s+(.*)$/);if(i){let e=i[1].length;r.push("<h".concat(e,">").concat(g(i[2]),"</h").concat(e,">"));continue}r.push("<p>".concat(g(t),"</p>"))}return s(),o&&a(),r.filter(Boolean).join("")},b=e=>(0,l.jsx)("svg",{viewBox:"0 0 20 20",fill:"none",stroke:"currentColor",...e,children:(0,l.jsx)("path",{d:"M7 5v10l7-5-7-5z",fill:"currentColor",stroke:"none"})}),h=e=>(0,l.jsx)("svg",{viewBox:"0 0 20 20",fill:"none",stroke:"currentColor",...e,children:(0,l.jsx)("path",{d:"M6 8l4 4 4-4",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})}),m=e=>(0,l.jsx)("svg",{viewBox:"0 0 20 20",fill:"none",stroke:"currentColor",...e,children:(0,l.jsx)("path",{d:"M6 12l4-4 4 4",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})}),f=e=>(0,l.jsxs)("svg",{viewBox:"0 0 20 20",fill:"none",stroke:"currentColor",...e,children:[(0,l.jsx)("rect",{x:"4",y:"4",width:"5",height:"12",rx:"1.5"}),(0,l.jsx)("rect",{x:"11",y:"4",width:"5",height:"12",rx:"1.5"})]}),v=e=>(0,l.jsxs)("svg",{viewBox:"0 0 20 20",fill:"none",stroke:"currentColor",...e,children:[(0,l.jsx)("path",{d:"M7 6 4 10l3 4",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}),(0,l.jsx)("path",{d:"m13 6 3 4-3 4",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})]}),y=e=>(0,l.jsxs)("svg",{viewBox:"0 0 20 20",fill:"none",stroke:"currentColor",...e,children:[(0,l.jsx)("circle",{cx:"7",cy:"6",r:"1"}),(0,l.jsx)("circle",{cx:"13",cy:"6",r:"1"}),(0,l.jsx)("circle",{cx:"7",cy:"10",r:"1"}),(0,l.jsx)("circle",{cx:"13",cy:"10",r:"1"}),(0,l.jsx)("circle",{cx:"7",cy:"14",r:"1"}),(0,l.jsx)("circle",{cx:"13",cy:"14",r:"1"})]}),w=e=>(0,l.jsxs)("svg",{viewBox:"0 0 20 20",fill:"none",stroke:"currentColor",...e,children:[(0,l.jsx)("path",{d:"M8 4H4v4",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}),(0,l.jsx)("path",{d:"M12 4h4v4",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}),(0,l.jsx)("path",{d:"M8 16H4v-4",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}),(0,l.jsx)("path",{d:"M12 16h4v-4",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})]}),k=e=>(0,l.jsxs)("svg",{viewBox:"0 0 20 20",fill:"currentColor",stroke:"none",...e,children:[(0,l.jsx)("circle",{cx:"5",cy:"10",r:"1.5"}),(0,l.jsx)("circle",{cx:"10",cy:"10",r:"1.5"}),(0,l.jsx)("circle",{cx:"15",cy:"10",r:"1.5"})]});var j=e=>{var t,r;let{cell:o,index:x,isActive:g,isEditing:j,canDelete:N,onSqlChange:C,onExecute:D,onDelete:E,onSelect:M,onEnterEditMode:S,onExitEditMode:A,onToggleCollapse:L,onToggleEditor:R,onToggleResult:P,onToggleFullscreen:_,onMoveUp:q,onMoveDown:I,isFullscreen:z=!1,dragState:O,onDragStart:T,onDragEnd:B,onDragOver:F,onDrop:W,onRunFromHere:H=()=>{},onRunToHere:$=()=>{}}=e,K=(0,n.useRef)(null),[Q,U]=(0,n.useState)(!1),J=(0,n.useRef)(null),[X,Y]=(0,n.useState)(!1),Z=(0,n.useRef)(null),G=!o.hideEditor&&!o.collapsed,V=!o.hideResult&&!o.collapsed,ee=(null!==(t=o.kind)&&void 0!==t?t:"sql")==="markdown",et=g&&!j&&!z,er=["rounded-xl","border","transition-all",j?"border-blue-400 ring-2 ring-blue-200 bg-white shadow-sm":et?"border-gray-300 bg-gray-50":"border-gray-200 bg-white"].join(" "),el=!ee&&!o.loading&&!!o.sql.trim(),en=Math.min(20,Math.max(4,o.sql.split("\n").length+1));(0,n.useEffect)(()=>{if(!Q)return;let e=e=>{J.current&&!J.current.contains(e.target)&&U(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[Q]),(0,n.useEffect)(()=>{if(!X)return;let e=e=>{Z.current&&!Z.current.contains(e.target)&&Y(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[X]),(0,n.useEffect)(()=>{ee&&X&&Y(!1)},[ee,X]);let eo=(0,n.useMemo)(()=>ee?o.loading?"Rendering markdown":o.lastExecutedAt?"Rendered ".concat(u(o.lastExecutedAt)):"Markdown cell":o.loading?"Running query":o.lastExecutedAt?"Ran ".concat(u(o.lastExecutedAt)):"Ready to run",[o.loading,o.lastExecutedAt,ee]),es=["flex","gap-3","rounded-2xl","border","bg-white/95","backdrop-blur-[2px]","transition-all",O.isDragOver?"ring-1 ring-indigo-300 border-indigo-300":et?"border-blue-400 ring-2 ring-blue-200":"border-gray-100",z?"shadow-[0_0_0_2px_rgba(99,102,241,0.35)] border-indigo-300":g?"shadow-[0_15px_35px_-20px_rgba(79,70,229,0.45)]":"shadow-sm hover:shadow-md hover:border-gray-200",o.loading?"ring-1 ring-blue-300 border-blue-200 bg-blue-50/80":""].join(" "),ea="absolute left-0 right-0 h-1 bg-indigo-500/80 rounded-full transition-opacity pointer-events-none opacity-0",ei=O.isDragOver?"after"===O.dragOverPosition?"translate-y-1.5":"-translate-y-1.5":"translate-y-0",ed=O.isDragOver&&"before"===O.dragOverPosition,ec=O.isDragOver&&"after"===O.dragOverPosition,eu="auto",ex=!z,eg=(0,n.useMemo)(()=>i.$f.of([{key:"Mod-Enter",run:()=>(D(),!0),preventDefault:!0},{key:"Mod-NumpadEnter",run:()=>(D(),!0),preventDefault:!0},{key:"Alt-Enter",run:()=>(null==H||H(),!0),preventDefault:!0},{key:"Shift-Enter",run:()=>(null==$||$(),!0),preventDefault:!0}]),[D,H,$]),ep=e=>{if(!K.current)return!1;let t=K.current.getBoundingClientRect();return e.clientY-t.top>t.height/2},eb=()=>{M(),S()},eh=()=>{A()};return(0,l.jsxs)("div",{className:"relative",children:[ed&&(0,l.jsx)("div",{className:"".concat(ea," top-0 opacity-100")}),(0,l.jsxs)("div",{ref:K,className:"".concat(es," ").concat(z?"h-full min-h-[calc(100vh-180px)]":""," ").concat(O.isDragging?"opacity-50 cursor-grabbing":""," transform transition-transform duration-150 ").concat(ei),onClick:M,draggable:!z,onDragStart:e=>{if(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",o.id),K.current){let t=K.current.getBoundingClientRect();e.dataTransfer.setDragImage(K.current,e.clientX-t.left,e.clientY-t.top)}T()},onDragEnd:e=>{e.preventDefault(),B()},onDragOver:e=>{e.preventDefault(),F(ep(e))},onDrop:e=>{e.preventDefault(),W(ep(e))},children:[ex&&(0,l.jsxs)("div",{className:"flex flex-col items-center gap-2 border-r border-gray-100 px-2 py-3",children:[(0,l.jsx)("div",{className:"cursor-grab rounded-full border bg-white p-2 text-gray-400 hover:text-gray-600 ".concat(O.isDragging?"border-indigo-300 text-indigo-500 cursor-grabbing":"border-gray-200"),children:(0,l.jsx)(y,{className:"h-4 w-4"})}),(0,l.jsxs)("div",{className:"flex flex-col gap-1 text-gray-400",children:[(0,l.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),L()},className:"rounded-md border px-1.5 py-1 text-xs ".concat(o.collapsed?"border-indigo-300 text-indigo-500":"border-gray-200 hover:text-gray-600"),title:o.collapsed?"Expand cell":"Collapse cell",children:o.collapsed?(0,l.jsx)(h,{className:"h-3 w-3"}):(0,l.jsx)(m,{className:"h-3 w-3"})}),!o.collapsed&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),R()},className:"rounded-md border px-1.5 py-1 text-xs ".concat(o.hideEditor?"border-indigo-300 text-indigo-500":"border-gray-200 hover:text-gray-600"),title:o.hideEditor?"Show SQL editor":"Collapse SQL editor",children:(0,l.jsx)(v,{className:"h-3.5 w-3.5"})}),(0,l.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),P()},className:"rounded-md border px-1.5 py-1 text-xs ".concat(o.hideResult?"border-indigo-300 text-indigo-500":"border-gray-200 hover:text-gray-600"),title:o.hideResult?"Show results":"Collapse results",children:(0,l.jsx)(f,{className:"h-3.5 w-3.5"})})]})]})]}),(0,l.jsxs)("div",{className:"flex-1 ".concat(ex?"p-3":"p-1 sm:p-3"," ").concat(ex?"":"md:px-6"),draggable:!1,children:[(0,l.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[ee?(0,l.jsxs)("button",{type:"button",onMouseDown:e=>e.stopPropagation(),onClick:e=>{e.stopPropagation(),el&&D()},disabled:!el,className:"inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs font-semibold transition ".concat(el?"border-blue-200 bg-blue-50 text-blue-600 hover:border-blue-300":"border-gray-200 text-gray-400 cursor-not-allowed"),title:"Render markdown",children:[(0,l.jsx)(b,{className:"h-3 w-3"}),"Render"]}):(0,l.jsxs)("div",{className:"relative",ref:Z,onMouseEnter:()=>{el&&Y(!0)},onMouseLeave:()=>Y(!1),children:[(0,l.jsx)("button",{type:"button",onMouseDown:e=>e.stopPropagation(),onClick:e=>{e.stopPropagation(),el&&(D(),Y(!1))},disabled:!el,className:"flex h-8 w-8 items-center justify-center rounded-full border text-sm font-semibold transition ".concat(el?X?"border-indigo-400 text-indigo-600 bg-indigo-50":"border-gray-300 text-gray-600 hover:border-indigo-300 hover:text-indigo-600":"border-gray-200 text-gray-400 cursor-not-allowed"),title:"Run cell",children:(0,l.jsx)(b,{className:"h-4 w-4"})}),X&&el&&(0,l.jsxs)("div",{className:"absolute left-0 mt-2 w-44 rounded-xl border border-gray-200 bg-white shadow-lg z-10",children:[(0,l.jsxs)("button",{className:"flex w-full items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:e=>{e.stopPropagation(),D(),Y(!1)},children:["Run cell",(0,l.jsx)("span",{className:"text-xs text-gray-400",children:"⌘⏎"})]}),(0,l.jsxs)("button",{className:"flex w-full items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:e=>{e.stopPropagation(),H(),Y(!1)},children:["Run from here",(0,l.jsx)("span",{className:"text-xs text-gray-400",children:"⌥⏎"})]}),(0,l.jsxs)("button",{className:"flex w-full items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:e=>{e.stopPropagation(),$(),Y(!1)},children:["Run to here",(0,l.jsx)("span",{className:"text-xs text-gray-400",children:"⇧⏎"})]})]})]}),(0,l.jsx)("span",{className:"inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold ".concat(o.loading?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-600"),children:eo})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-[11px] font-medium text-gray-400",children:"⌘⏎ to run cell"}),(0,l.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),_()},onMouseDown:e=>e.stopPropagation(),onDragStart:e=>e.preventDefault(),className:"rounded-full border p-1.5 text-gray-500 hover:text-gray-700 ".concat(z?"border-indigo-300 text-indigo-500":"border-gray-200 hover:border-gray-300"),title:z?"Exit fullscreen":"Fullscreen cell",children:(0,l.jsx)(w,{className:"h-4 w-4"})}),!z&&(0,l.jsxs)("div",{className:"relative",ref:J,children:[(0,l.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),U(e=>!e)},className:"rounded-full border border-gray-200 p-1.5 text-gray-400 hover:border-gray-300 hover:text-gray-600",title:"Cell options",children:(0,l.jsx)(k,{className:"h-4 w-4"})}),Q&&(0,l.jsxs)("div",{className:"absolute right-0 mt-2 w-40 rounded-xl border border-gray-200 bg-white shadow-lg z-10",children:[(0,l.jsxs)("button",{className:"flex w-full items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:e=>{e.stopPropagation(),q(),U(!1)},children:["Move cell up",(0,l.jsx)("span",{className:"text-xs text-gray-400",children:"⌘↑"})]}),(0,l.jsxs)("button",{className:"flex w-full items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:e=>{e.stopPropagation(),I(),U(!1)},children:["Move cell down",(0,l.jsx)("span",{className:"text-xs text-gray-400",children:"⌘↓"})]}),N&&(0,l.jsx)("button",{className:"flex w-full items-center justify-between px-3 py-2 text-sm text-red-600 hover:bg-red-50",onClick:e=>{e.stopPropagation(),E(),U(!1)},children:"Delete"})]})]})]})]}),!o.collapsed&&(0,l.jsxs)("div",{className:"mt-2 space-y-3 ".concat(z?"flex-1 flex flex-col overflow-hidden":""),onClick:M,children:[G?(0,l.jsx)("div",{className:"".concat(er," overflow-hidden"),"data-notebook-editor":"true",children:ee?(0,l.jsx)("textarea",{value:o.sql,onChange:e=>C(e.target.value),onFocus:eb,onBlur:eh,onKeyDown:e=>{(e.metaKey||e.ctrlKey)&&("Enter"===e.key||"NumpadEnter"===e.key)&&(e.preventDefault(),D())},rows:en,disabled:o.loading,className:"w-full resize-none border-none bg-transparent px-4 py-3 text-sm text-gray-900 focus:outline-none ".concat(o.loading?"text-gray-400":""),placeholder:"Write markdown..."}):(0,l.jsx)(s.ZP,{value:o.sql,theme:c.tR,height:eu,extensions:[c.MH,i.tk.lineWrapping,(0,i.Eu)(),(0,d.ys)({icons:!1}),(0,a.i6)(),eg],basicSetup:!1,onChange:C,editable:!o.loading,onFocus:eb,onBlur:eh,style:{fontSize:"14px",height:eu,minHeight:"44px"}})}):(0,l.jsxs)("div",{className:"w-full rounded-xl border border-dashed px-3 py-2 text-left text-sm cursor-pointer ".concat(et?"border-blue-200 text-blue-600 bg-blue-50/50":"border-gray-200 text-gray-600 bg-white"," hover:border-indigo-300 hover:text-indigo-600"),onClick:e=>{e.stopPropagation(),R()},children:[(0,l.jsx)("div",{className:"font-mono whitespace-pre-wrap overflow-hidden",style:{maxHeight:"48px"},children:o.sql||"SQL editor collapsed"}),(0,l.jsx)("div",{className:"text-xs text-indigo-500 font-semibold mt-1",children:"Show editor"})]}),ee&&V&&(0,l.jsx)("div",{className:"rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm text-gray-800",children:o.renderedMarkdown?(0,l.jsx)("div",{className:"space-y-2 leading-relaxed markdown-preview",dangerouslySetInnerHTML:{__html:p(o.renderedMarkdown)}}):(0,l.jsx)("p",{className:"text-xs text-gray-500",children:"Run the cell to render its markdown preview."})}),o.error&&V&&(0,l.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:o.error}),!ee&&!o.error&&V&&o.result&&(0,l.jsxs)("div",{className:"".concat(z?"flex-1 flex flex-col":""),children:[(0,l.jsxs)("div",{className:"text-xs font-semibold uppercase tracking-wide text-gray-400",children:[o.result.rowCount," row",1===o.result.rowCount?"":"s"," returned ",o.result.duration?"in ".concat(o.result.duration):""]}),(0,l.jsx)("div",{className:"".concat(z?"flex-1 overflow-auto rounded-xl border border-gray-100 bg-white mt-2":"space-y-3"),children:(r=o.result).data&&0!==r.data.length?(0,l.jsx)("div",{className:"rounded-lg border border-gray-200 overflow-hidden",children:(0,l.jsx)("div",{className:"overflow-auto max-h-72",children:(0,l.jsxs)("table",{className:"min-w-full text-sm",children:[(0,l.jsx)("thead",{className:"bg-gray-50",children:(0,l.jsx)("tr",{children:r.columns.map((e,t)=>(0,l.jsxs)("th",{className:"px-4 py-3 text-left font-semibold text-gray-700",children:[(0,l.jsx)("div",{children:e}),r.types&&r.types[t]&&(0,l.jsx)("div",{className:"text-xs text-gray-400",children:r.types[t]})]},e+t))})}),(0,l.jsx)("tbody",{children:r.data.map((e,t)=>(0,l.jsx)("tr",{className:t%2==0?"bg-white":"bg-gray-50",children:e.map((e,t)=>(0,l.jsx)("td",{className:"px-4 py-2 text-gray-800 font-mono text-xs",children:e},t))},t))})]})})}):(0,l.jsx)("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-3 text-center text-sm text-gray-500",children:"No data returned"})})]}),!o.error&&!V&&!o.collapsed&&!ee]})]})]}),ec&&(0,l.jsx)("div",{className:"".concat(ea," bottom-0 opacity-100")})]})};let N="bendsql-notebooks",C={getNotebooks(){try{let e=localStorage.getItem(N);if(e){let t=JSON.parse(e);return{notebooks:t.notebooks.map(e=>({...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),cells:e.cells.map(e=>{var t,r,l,n;return{...e,collapsed:null!==(t=e.collapsed)&&void 0!==t&&t,hideEditor:null!==(r=e.hideEditor)&&void 0!==r&&r,hideResult:null!==(l=e.hideResult)&&void 0!==l&&l,lastExecutedAt:e.lastExecutedAt?new Date(e.lastExecutedAt):void 0,kind:null!==(n=e.kind)&&void 0!==n?n:"sql",renderedMarkdown:"string"==typeof e.renderedMarkdown?e.renderedMarkdown:void 0}})})),currentNotebookId:t.currentNotebookId}}}catch(e){console.error("Failed to load notebooks from storage:",e)}return{notebooks:[]}},saveNotebooks(e){try{localStorage.setItem(N,JSON.stringify(e))}catch(e){console.error("Failed to save notebooks to storage:",e)}},createNotebook(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Untitled Notebook",t=new Date;return{id:D(),name:e,cells:[{id:D(),sql:"",loading:!1,collapsed:!1,hideEditor:!1,hideResult:!1,kind:"sql",renderedMarkdown:void 0}],createdAt:t,updatedAt:t}},createCell:()=>({id:D(),sql:"",loading:!1,collapsed:!1,hideEditor:!1,hideResult:!1,kind:"sql",renderedMarkdown:void 0})};function D(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}var E=r(2081),M=()=>{let{currentDsn:e}=(0,E.X)(),[t,r]=(0,n.useState)([]),[s,a]=(0,n.useState)(null),[i,d]=(0,n.useState)(null),[c,x]=(0,n.useState)(""),[g,p]=(0,n.useState)(null),[b,h]=(0,n.useState)({id:null,placeAfter:!1}),[m,f]=(0,n.useState)(null),[v,y]=(0,n.useState)(!1),[w,N]=(0,n.useState)(null),D=(0,n.useRef)(null),M=(0,n.useRef)(null),[S,A]=(0,n.useState)(!1),L=(0,n.useRef)(null),[R,P]=(0,n.useState)(null),[_,q]=(0,n.useState)([]),I=(0,n.useRef)(null);(0,n.useEffect)(()=>{L.current=s},[s]),(0,n.useEffect)(()=>{if(!s){P(null);return}R&&!s.cells.some(e=>e.id===R)&&P(null)},[s,R]),(0,n.useEffect)(()=>{let e=C.getNotebooks();r(e.notebooks);let t=e.notebooks[0];if(e.currentNotebookId){let r=e.notebooks.find(t=>t.id===e.currentNotebookId);r&&(t=r)}if(t){var l,n;a(t),d(null!==(n=null===(l=t.cells[0])||void 0===l?void 0:l.id)&&void 0!==n?n:null)}},[]),(0,n.useEffect)(()=>{C.saveNotebooks({notebooks:t,currentNotebookId:null==s?void 0:s.id})},[t,s]),(0,n.useEffect)(()=>{if(!s){d(null);return}if(!s.cells.some(e=>e.id===i)){var e,t;d(null!==(t=null===(e=s.cells[0])||void 0===e?void 0:e.id)&&void 0!==t?t:null)}},[s,i]),(0,n.useEffect)(()=>{if(!v)return;let e=e=>{M.current&&!M.current.contains(e.target)&&y(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[v]),(0,n.useEffect)(()=>{if(!w)return;let e=e=>{e.target.closest("[data-notebook-menu]")||N(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[w]);let z=(0,n.useMemo)(()=>{if(!c.trim())return t;let e=c.toLowerCase();return t.filter(t=>t.name.toLowerCase().includes(e))},[t,c]),O=(0,n.useCallback)(()=>{var e,t;let l=C.createNotebook();r(e=>[...e,l]),a(l),d(null!==(t=null===(e=l.cells[0])||void 0===e?void 0:e.id)&&void 0!==t?t:null),P(null)},[]),T=(0,n.useCallback)(e=>{var r,l;let n=t.find(t=>t.id===e);n&&(a(n),d(null!==(l=null===(r=n.cells[0])||void 0===r?void 0:r.id)&&void 0!==l?l:null),P(null))},[t]),B=(0,n.useCallback)((e,t)=>{r(r=>r.map(r=>r.id===e?{...r,name:t,updatedAt:new Date}:r)),(null==s?void 0:s.id)===e&&a(e=>e?{...e,name:t,updatedAt:new Date}:null)},[s]),F=(0,n.useCallback)(e=>{if(!s)return;let t=C.createCell(),l=[...s.cells],n=Math.max(0,Math.min(e,l.length));l.splice(n,0,t);let o={...s,cells:l,updatedAt:new Date};d(t.id),P(null),a(o),r(e=>e.map(e=>e.id===o.id?o:e))},[s]),W=(0,n.useCallback)(()=>{var e;null===(e=D.current)||void 0===e||e.focus()},[]),H=(0,n.useCallback)(()=>{a(null),d(null),f(null),P(null)},[]),$=(0,n.useCallback)(()=>{if(!s)return;let e=C.createCell(),t={...s,cells:[e],updatedAt:new Date};a(t),r(e=>e.map(e=>e.id===t.id?t:e)),d(e.id),f(null),P(null)},[s]),K=(0,n.useCallback)(e=>{r(t=>{if(-1===t.findIndex(t=>t.id===e))return t;let r=t.filter(t=>t.id!==e);if((null==s?void 0:s.id)===e){var l,n;let e=r.length>0?r[0]:null;a(e),d(null!==(n=null==e?void 0:null===(l=e.cells[0])||void 0===l?void 0:l.id)&&void 0!==n?n:null),f(null),P(null)}else if(R){let r=t.find(t=>t.id===e);(null==r?void 0:r.cells.some(e=>e.id===R))&&P(null)}return r}),q(t=>t.filter(t=>t.notebookId!==e)),N(null)},[s,R]),Q=(0,n.useCallback)(()=>{f(null)},[]),U=(0,n.useCallback)((e,t)=>{if(!s)return;let l={...s,cells:s.cells.map(r=>r.id===e?{...r,sql:t}:r),updatedAt:new Date};a(l),r(e=>e.map(e=>e.id===l.id?l:e))},[s]),J=(0,n.useCallback)((e,t)=>{if(!s)return;let l={...s,cells:s.cells.map(r=>r.id===e?{...r,[t]:!r[t]}:r),updatedAt:new Date};a(l),r(e=>e.map(e=>e.id===l.id?l:e))},[s]),X=(0,n.useCallback)(function(e,t){let l=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!s||e===t)return!1;let n=[...s.cells],o=n.findIndex(t=>t.id===e),i=n.findIndex(e=>e.id===t);if(-1===o||-1===i)return!1;let[c]=n.splice(o,1);n.splice(l?i+1:i,0,c);let u={...s,cells:n,updatedAt:new Date};return a(u),r(e=>e.map(e=>e.id===u.id?u:e)),d(c.id),!0},[s]),Y=(0,n.useCallback)((e,t)=>{if(!s)return;let r=s.cells,l=r.findIndex(t=>t.id===e);if(-1===l)return;let n="up"===t?l-1:l+1;n<0||n>=r.length||X(e,r[n].id,"down"===t)},[s,X]),Z=(0,n.useCallback)(e=>{p(e),h({id:null,placeAfter:!1})},[]),G=(0,n.useCallback)(()=>{p(null),h({id:null,placeAfter:!1})},[]),V=(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];g&&g!==e&&X(g,e,t)&&h({id:e,placeAfter:t})},[g,X]),ee=(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];g&&g!==e&&X(g,e,t),p(null),h({id:null,placeAfter:!1})},[g,X]),et=(0,n.useCallback)(async t=>{let l=L.current;if(!l)return{success:!1};let n=l.cells.find(e=>e.id===t);if(!n)return{success:!1};d(t);let o={...l,cells:l.cells.map(e=>{if(e.id!==t)return e;let r={...e,loading:!0,error:void 0,result:void 0};return"markdown"===e.kind?{...r,renderedMarkdown:void 0}:r})};if(a(o),L.current=o,"markdown"===n.kind){let e={...o,cells:o.cells.map(e=>e.id===t?{...e,loading:!1,renderedMarkdown:n.sql,lastExecutedAt:new Date}:e),updatedAt:new Date};return a(e),L.current=e,r(t=>t.map(t=>t.id===e.id?e:t)),{success:!0}}if(!n.sql.trim()){let e={...o,cells:o.cells.map(e=>e.id===t?{...e,loading:!1}:e),updatedAt:new Date};return a(e),L.current=e,r(t=>t.map(t=>t.id===e.id?e:t)),{success:!0}}try{let l=await fetch("/api/query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sql:n.sql,kind:0,dsn:e.dsn||void 0})});if(!l.ok){let e="HTTP error! status: ".concat(l.status);try{let t=await l.json();t.error&&(e=t.error)}catch(e){}throw Error(e)}let s=(await l.json()).results||[],i=s.length>0?s[s.length-1]:void 0,d={...o,cells:o.cells.map(e=>e.id===t?{...e,loading:!1,result:i,error:void 0,lastExecutedAt:new Date}:e),updatedAt:new Date};return a(d),L.current=d,r(e=>e.map(e=>e.id===d.id?d:e)),{success:!0}}catch(n){console.error("Cell execution failed:",n);let e=n.message.replace(/\\n/g,"\n"),l={...o,cells:o.cells.map(r=>r.id===t?{...r,loading:!1,error:"Query execution failed: "+e,result:void 0}:r),updatedAt:new Date};return a(l),L.current=l,r(e=>e.map(e=>e.id===l.id?l:e)),{success:!1,error:e}}},[e]),er=(0,n.useCallback)(async e=>{let t=L.current;if(t)for(let r of t.cells.slice(e).map(e=>e.id)){let e=await et(r);if(!(null==e?void 0:e.success))break}},[et]),el=(0,n.useCallback)(async e=>{let t=L.current;if(t)for(let r of t.cells.slice(0,Math.min(e+1,t.cells.length)).map(e=>e.id)){let e=await et(r);if(!(null==e?void 0:e.success))break}},[et]),en=(0,n.useCallback)((e,t)=>{if(!s||s.cells.length<=1)return;let l=s.cells.findIndex(t=>t.id===e);if(-1===l)return;let n=s.cells[l],o=s.cells[l+1]||s.cells[l-1],i={...s,cells:s.cells.filter(t=>t.id!==e),updatedAt:new Date};(null==t?void 0:t.recordHistory)!==!1&&q(e=>[...e,{notebookId:s.id,cell:n,index:l}]),d(t=>{var r;return t===e?null!==(r=null==o?void 0:o.id)&&void 0!==r?r:null:t}),P(t=>t===e?null:t),a(i),r(e=>e.map(e=>e.id===i.id?i:e)),f(t=>t===e?null:t)},[s]),eo=(0,n.useCallback)(()=>{q(e=>{let t=[...e];for(;t.length>0;){var l;let e=t.pop(),n=t=>{let r=[...t.cells],l=Math.min(e.index,r.length);return r.splice(l,0,{...e.cell,loading:!1}),{...t,cells:r,updatedAt:new Date}},o=!1;if(r(t=>t.some(t=>t.id===e.notebookId)?(o=!0,t.map(t=>t.id===e.notebookId?n(t):t)):t),o&&(null===(l=L.current)||void 0===l?void 0:l.id)===e.notebookId){let t=n(L.current);a(t),L.current=t,d(e.cell.id),P(null);break}if(o)break}return t})},[r]),es=(0,n.useCallback)((e,t)=>{if(!s||!s.cells.some(t=>t.id===e))return;let l={...s,cells:s.cells.map(r=>r.id===e?{...r,kind:t,hideEditor:!1,result:"markdown"===t?void 0:r.result,error:"markdown"===t?void 0:r.error,renderedMarkdown:void 0}:r),updatedAt:new Date};a(l),r(e=>e.map(e=>e.id===l.id?l:e)),"markdown"===t&&P(null)},[s]),ea=(0,n.useCallback)(async()=>{await er(0)},[er]);(0,n.useEffect)(()=>{let e=e=>{var t;let r=L.current;if(!r||!i)return;if(R===i){if("Escape"===e.key){e.preventDefault(),P(null);let t=document.activeElement;t&&"function"==typeof t.blur&&t.blur()}return}let l=e.target,n=null==l?void 0:null===(t=l.tagName)||void 0===t?void 0:t.toLowerCase();if("input"===n||"textarea"===n||(null==l?void 0:l.isContentEditable))return;let o=r.cells.findIndex(e=>e.id===i);if(-1===o||e.metaKey||e.ctrlKey)return;let s=e.key.toLowerCase();if("d"===s){let t=I.current,r=Date.now();if(t&&"d"===t.key&&r-t.timestamp<500){e.preventDefault(),I.current=null,en(i);return}I.current={key:"d",timestamp:r};return}switch(I.current=null,s){case"a":e.preventDefault(),F(o);break;case"b":e.preventDefault(),F(o+1);break;case"x":e.preventDefault(),en(i);break;case"z":_.length>0&&(e.preventDefault(),eo());break;case"m":e.preventDefault(),es(i,"markdown");break;case"y":e.preventDefault(),es(i,"sql")}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[i,R,F,en,eo,es,_.length]),(0,n.useEffect)(()=>{if(!m)return;let e=e=>{"Escape"===e.key&&(e.preventDefault(),Q())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[m,Q]);let ei=(e,t)=>{if(m)return null;let r="between"===e?"Add cell between":"above"===e?"Add cell above":"Add cell below";return(0,l.jsxs)("button",{type:"button",onClick:()=>F(t),className:"group relative flex w-full items-center justify-center py-1 focus:outline-none",title:r,children:[(0,l.jsx)("span",{className:"pointer-events-none h-px w-full bg-gray-200 transition-colors group-hover:bg-indigo-300"}),(0,l.jsxs)("span",{className:"pointer-events-none absolute left-1/2 -translate-x-1/2 -translate-y-1/2 whitespace-nowrap rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-semibold text-gray-600 opacity-0 shadow group-hover:-translate-y-1 group-hover:opacity-100 group-hover:border-indigo-300 group-hover:text-indigo-600",children:["+ ",r]})]},"add-control-".concat(t))};return(0,l.jsxs)("div",{className:"relative flex h-full flex-1 flex-col bg-[#f4f6fb]",children:[(0,l.jsxs)(o.eh,{direction:"horizontal",className:"flex-1 overflow-hidden",children:[(0,l.jsx)(o.s_,{defaultSize:15,minSize:15,maxSize:30,className:"h-full",children:(0,l.jsxs)("div",{className:"flex h-full flex-col border-r border-gray-200 bg-white",children:[(0,l.jsxs)("div",{className:"p-3 border-b border-gray-100",children:[(0,l.jsx)("label",{className:"text-xs font-semibold uppercase tracking-wide text-gray-400 mb-2 block",children:"Search"}),(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)("span",{className:"absolute inset-y-0 left-3 flex items-center text-gray-400",children:(0,l.jsxs)("svg",{className:"h-4 w-4",viewBox:"0 0 20 20",fill:"none",stroke:"currentColor",children:[(0,l.jsx)("path",{d:"m13.5 13.5 3 3",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}),(0,l.jsx)("circle",{cx:"9",cy:"9",r:"5.5",strokeWidth:"1.6"})]})}),(0,l.jsx)("input",{value:c,onChange:e=>x(e.target.value),placeholder:"Find notebook",className:"w-full rounded-lg border border-gray-200 bg-gray-50 pl-8 pr-3 py-2 text-sm text-gray-700 focus:border-indigo-400 focus:bg-white focus:outline-none"})]})]}),(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 text-xs font-semibold uppercase tracking-wide text-gray-500",children:[(0,l.jsxs)("button",{type:"button",className:"inline-flex items-center gap-2 rounded-full border border-transparent px-2 py-1 text-xs font-semibold text-gray-500 hover:text-gray-700",onClick:()=>A(e=>!e),children:[(0,l.jsx)("span",{children:S?"▶":"▼"}),(0,l.jsx)("span",{children:"Notebooks"})]}),(0,l.jsx)("button",{type:"button",onClick:O,className:"rounded-full border border-gray-200 px-2 py-1 text-sm font-semibold text-gray-600 hover:border-indigo-300 hover:text-indigo-600",title:"Add notebook",children:"+"})]}),!S&&(0,l.jsxs)("div",{className:"px-2 pb-3 space-y-1",children:[0===z.length&&(0,l.jsx)("div",{className:"text-center text-sm text-gray-500 px-2 py-4",children:"No notebooks found"}),z.map(e=>{let t=(null==s?void 0:s.id)===e.id,r=w===e.id;return(0,l.jsx)("div",{className:"space-y-1","data-notebook-menu":r?"true":void 0,children:(0,l.jsxs)("button",{onClick:()=>T(e.id),className:"w-full text-left px-3 py-2 rounded-lg border transition-all ".concat(t?"border-indigo-300 bg-indigo-50/70 text-indigo-700":"border-transparent hover:border-gray-200 hover:bg-gray-50"),children:[(0,l.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"font-semibold text-sm truncate",children:e.name||"Untitled Notebook"}),(0,l.jsxs)("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[(0,l.jsx)("span",{className:"uppercase",children:u(e.updatedAt)||"new"}),(0,l.jsxs)("div",{className:"relative","data-notebook-menu-button":!0,children:[(0,l.jsx)("button",{type:"button",onClick:t=>{t.stopPropagation(),N(t=>t===e.id?null:e.id)},className:"rounded-full border p-1 transition ".concat(r?"border-indigo-300 text-indigo-600":"border-gray-200 text-gray-500 hover:border-gray-300"),title:"Notebook options",children:(0,l.jsx)(k,{className:"h-3.5 w-3.5"})}),r&&(0,l.jsx)("div",{className:"absolute right-0 mt-2 w-40 rounded-xl border border-gray-200 bg-white shadow-lg z-10",children:(0,l.jsx)("button",{type:"button",onClick:t=>{t.stopPropagation(),K(e.id),N(null)},className:"flex w-full items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50",children:"Delete notebook"})})]})]})]}),(0,l.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:[e.cells.length," cell",1===e.cells.length?"":"s"]})]})},e.id)})]})]})]})}),(0,l.jsx)(o.OT,{className:"group flex w-3 cursor-col-resize items-center justify-center",children:(0,l.jsx)("span",{className:"h-10 w-0.5 rounded-full bg-gray-200 group-hover:bg-indigo-400"})}),(0,l.jsx)(o.s_,{defaultSize:60,minSize:40,className:"h-full",children:(0,l.jsx)("div",{className:"flex h-full flex-col overflow-hidden",children:s?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("header",{className:"border-b border-gray-200 bg-white px-4 py-3 flex items-center justify-between gap-3",children:[(0,l.jsxs)("div",{className:"min-w-0",children:[(0,l.jsx)("input",{ref:D,type:"text",value:s.name,onChange:e=>B(s.id,e.target.value),className:"w-full border-none bg-transparent text-xl font-semibold text-gray-900 focus:outline-none",placeholder:"Notebook name"}),(0,l.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["Updated ",u(s.updatedAt)||"just now"," \xb7 ",s.cells.length," cell",1===s.cells.length?"":"s"]})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[(0,l.jsx)("button",{type:"button",onClick:()=>{ea()},className:"inline-flex items-center gap-1 rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1.5 text-xs font-semibold text-indigo-600 shadow-sm hover:bg-indigo-100",children:"Run all cells"}),(0,l.jsxs)("div",{className:"relative",ref:M,children:[(0,l.jsx)("button",{type:"button",onClick:()=>y(e=>!e),className:"rounded-full border p-1.5 transition ".concat(v?"border-indigo-300 text-indigo-600":"border-gray-200 text-gray-500 hover:border-gray-300"),title:"Notebook options",children:(0,l.jsx)(k,{className:"h-4 w-4"})}),v&&(0,l.jsxs)("div",{className:"absolute right-0 mt-2 w-44 rounded-xl border border-gray-200 bg-white shadow-lg z-10",children:[(0,l.jsx)("button",{className:"flex w-full items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:()=>{W(),y(!1)},children:"Rename"}),(0,l.jsx)("button",{className:"flex w-full items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",onClick:()=>{H(),y(!1)},children:"Close"}),(0,l.jsx)("button",{className:"flex w-full items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50",onClick:()=>{$(),y(!1)},children:"Delete all cells"})]})]})]})]}),(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-4 ".concat(m?"space-y-0":"space-y-3"),children:[!m&&ei("above",0),s.cells.map((e,t)=>m&&e.id!==m?null:(0,l.jsxs)(n.Fragment,{children:[(0,l.jsx)(j,{cell:e,index:t,onSqlChange:t=>U(e.id,t),onExecute:()=>et(e.id),onDelete:()=>en(e.id),canDelete:s.cells.length>1,isActive:e.id===i||m===e.id,isEditing:R===e.id,onSelect:()=>{d(e.id),P(null)},onEnterEditMode:()=>{d(e.id),P(e.id)},onExitEditMode:()=>{P(t=>t===e.id?null:t)},onToggleCollapse:()=>J(e.id,"collapsed"),onToggleEditor:()=>J(e.id,"hideEditor"),onToggleResult:()=>J(e.id,"hideResult"),onToggleFullscreen:()=>f(t=>t===e.id?null:e.id),isFullscreen:m===e.id,onMoveUp:()=>Y(e.id,"up"),onMoveDown:()=>Y(e.id,"down"),dragState:{isDragging:g===e.id,isDragOver:b.id===e.id,dragOverPosition:b.id===e.id?b.placeAfter?"after":"before":void 0},onDragStart:()=>Z(e.id),onDragEnd:G,onDragOver:t=>V(e.id,t),onDrop:t=>ee(e.id,t),onRunFromHere:()=>{er(t)},onRunToHere:()=>{el(t)}}),!m&&ei(t===s.cells.length-1?"below":"between",t+1)]},e.id)),!m&&ei("below",s.cells.length)]})]}):(0,l.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,l.jsxs)("div",{className:"text-center max-w-xs",children:[(0,l.jsx)("p",{className:"text-lg font-semibold text-gray-800 mb-2",children:"No notebooks yet"}),(0,l.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:"Create your first notebook to start experimenting with queries."}),(0,l.jsx)("button",{onClick:O,className:"rounded-xl bg-indigo-600 px-5 py-2 text-sm font-medium text-white hover:bg-indigo-500",children:"Create Notebook"})]})})})})]}),m&&(0,l.jsx)("div",{className:"absolute inset-x-0 top-[68px] z-10 flex justify-end px-6",children:(0,l.jsx)("button",{onClick:Q,className:"rounded-full border border-gray-300 bg-white px-3 py-1 text-xs font-semibold text-gray-600 shadow-sm hover:border-gray-400",children:"Exit fullscreen ⎋"})})]})}}}]);